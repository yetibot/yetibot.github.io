<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Yetibot: Ops Guide</title>
    <link rel="canonical" href="https://yetibot.com/ops-guide">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/css/main.css" rel="stylesheet" type="text/css" />
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="/img/favicon/site.webmanifest">
    <link rel="mask-icon" href="/img/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/img/favicon/favicon.ico">

    
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://yetibot.com/ops-guide" />
    <meta property="og:title" content="Yetibot: Ops Guide" />
    <meta property="og:description"
      content="Yeitbot is a powerful, expressive chatops platform written in Clojure." />
    <meta property="og:image"
      content="https://yetibot.com/img/yetibot_logo.svg"
    />
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:domain" value="yetibot.com" />
    <meta name="twitter:title" value="Yetibot: Ops Guide" />
    <meta name="twitter:description"
      value="Yeitbot is a powerful, expressive chatops platform written in Clojure."
    />
    <meta name="twitter:image"
      content="https://yetibot.com/img/yetibot_logo.svg"
    />
    <meta name="twitter:url" value="https://yetibot.com/ops-guide" />
    
    

    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="msapplication-config" content="/img/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117101667-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-117101667-1');
    </script>
  </head>
  <body class="">


    <div class="main-content">
      <nav class="navbar is-black" role="navigation" aria-label="main navigation">
        <div class="container">
          <div class="navbar-brand">
            <a class="navbar-item" href="/">
              <img class="nav-logo" src="/img/yetibot_lambda_blue_with_grey.svg"
                                    alt="Yetibot: A powerful, expressive chatops platform written in Clojure."
                                    />
            </a>

            <div class="navbar-burger" data-target="nav-menu">
              <span></span>
              <span></span>
              <span></span>
            </div>

          </div>
          <div class="navbar-menu" id="nav-menu">
            <div class="navbar-start">

              
              <a href="/user-guide"
                class="navbar-item is-tab
                ">
                User Guide
              </a>
              
              <a href="/dev-guide"
                class="navbar-item is-tab
                ">
                Dev Guide
              </a>
              
              <a href="/ops-guide"
                class="navbar-item is-tab
                is-active">
                Ops Guide
              </a>
              
              <a href="/community"
                class="navbar-item is-tab
                ">
                Community
              </a>
              
              <a href="/media"
                class="navbar-item is-tab
                ">
                Media
              </a>
              

              <a class="navbar-item is-tab
                " href="/archives">
                Blog
              </a>
            </div>
            <div class="navbar-end">

              <a href="https://twitter.com/yetibot_chatops"
                 title="Yetibot on Twitter"
                 class="navbar-item">
                <span class="icon">
                  <i class="fab fa-twitter"></i>
                </span>
              </a>
              <a href="https://github.com/yetibot/yetibot"
                 title="Yetibot on GitHub"
                 class="navbar-item">
                <span class="icon">
                  <i class="fab fa-github"></i>
                </span>
              </a>
              <a class="navbar-item"
                 title="Yetibot Slack"
                 href="https://slack.yetibot.com">
                <span class="icon">
                  <i class="fab fa-slack"></i>
                </span>
              </a>

            </div>
          </div>
        </div>
      </nav>

      

<article class="page-title hero is-light is-bold is-fullwidth">
  <div class="hero-body">
    <div class="container">
      <h1 class="title">Ops Guide</h1>
      <p class="subtitle">Running and operating a Yetibot</p>
    </div>
  </div>
</article>

<section class="section content">

  <div class="container">
    <div id="page">
      <div class="main columns">
        <div class="column main-content is-two-thirds">
          <p><!&ndash; can't indent this properly because Markdown turns it into a code block &ndash;> <article class="message is-info"> <div class="message-header">   <p>Tip</p> </div> <div class="message-body">   This guide is all about running and operating a Yetibot. It documents system   dependencies, Docker usage, and configuration mechanisms.</p><ul><li>If you're more interested using Yetibot, check out the  <a href='/user-guide'>User Guide</a>.</li><li>If you're more interested in Yetibot's internals or building features, check  out the <a href='/dev-guide'>Developer Guide</a>.</div></article></li></ul><p><article class="message is-info"> <div class="message-header">   <p>Getting help</p> </div> <div class="message-body">   Although we hope the docs are useful and comprehensive,   <strong>don't hesitate to ask for help in <a href='https://slack.yetibot.com'>Slack</a>!</strong>   It could potentially save you a lot of time. </div> </article></p><h2 id="up&#95;and&#95;running">Up and running</h2><p>To get a Yetibot running you need:</p><ol><li>Some config</li><li>A Postgres database</li><li>A way to run it (i.e. <code>docker</code> or <code>lein</code>)</li></ol><p>Note: Yetibot runs on Java 11+. This is because Yetibot uses the Java 11 async HTTP client. If you run Yetibot via Docker then this is already taken care of.</p><h3 id="docker&#95;compose">Docker Compose</h3><p>Docker Compose satisfies these requirements very quickly. Run from the root of the <a href='https://github.com/yetibot/yetibot'>Yetibot repo</a>:</p><pre><code class="bash">docker-compose up
</code></pre><p>This starts up a Postgres container and a Yetibot container, configured to connect to IRC as user name <code>yetibot&#95;demo</code>. Once it's up check out <a href='http://localhost:3456'>http://localhost:3456</a> to view the dashboard.</p><p>See the <a href='https://github.com/yetibot/yetibot/blob/master/docker-compose.yml'>docker-compose.yml</a> file to look at exactly how these containers are configured. This demonstrates a very minimal default config that you can modify. For example, you could use Slack instead by switching to a config like:</p><pre><code class="yaml">    environment:
      - YB&#95;ADAPTERS&#95;SLACK&#95;TYPE=slack
      - YB&#95;ADAPTERS&#95;SLACK&#95;TOKEN=xoxb-my-token
      - YB&#95;DB&#95;URL=postgresql://yetibot:yetibot@postgres:5432/yetibot
</code></pre><p><article class="message is-warning"> <div class="message-header">   <p>üê≥üê≥üê≥</p> </div> <div class="message-body">   For your reference, see Yetibot's   <a href='https://github.com/yetibot/yetibot/blob/master/Dockerfile'><code>Dockerfile</code></a>.</p><p>  If you decide to override the default command, make sure you activate the   <code>docker</code> profile (e.g. <code>lein with-profile +docker run</code>) as this properly   specifies the <code>.java.policy</code> location, which is necessary for the JVM Sandbox   utilized by the <code>clj</code> command. </div> </article></p><h3 id="kubernetes&#95;with&#95;helm">Kubernetes with Helm</h3><p>Running on Kubernetes is super simple with the official <a href='https://github.com/yetibot/yetibot-helm'>yetibot-helm</a> chart.</p><h3 id="minimal&#95;config">Minimal config</h3><p>A very minimal config would be <code>config/config.edn</code>:</p><pre><code class="clojure">{:yetibot
  {:adapters {:freenode {:type &quot;irc&quot;,
                        :username &quot;my-yetibot&quot;,
                        :host &quot;chat.freenode.net&quot;,
                        :port &quot;7070&quot;,
                        :ssl &quot;true&quot;}}}}
</code></pre><p>This instructs Yetibot to join freenode with the username <code>my-yetibot</code> (change it to whatever you like).</p><p>If you don't configure a Postgres database, it defaults to:</p><pre><code class="bash">postgresql://localhost:5432/yetibot
</code></pre><p>It expects the database to already exist, but any tables will be created idempotently on startup. To override the default connection string along with the above config, it'd look like:</p><pre><code class="clojure">{:yetibot
 {:adapters {:freenode {:type &quot;irc&quot;,
                        :username &quot;my-yetibot&quot;,
                        :host &quot;chat.freenode.net&quot;,
                        :port &quot;7070&quot;,
                        :ssl &quot;true&quot;}}
  :db {:url &quot;postgresql://user:pass@mydb:5432/yetibot&quot;}}}
</code></pre><p>For full config see the <a href='#configuration'>Configuration docs</a>.</p><h3 id="postgres">Postgres</h3><p>There are many ways to install Postgres. Here we demonstrate two common approaches:</p><h4 id="docker">Docker</h4><p>As usual, Docker makes things easier when it comes to infra:</p><pre><code class="bash">
docker run -d -p 5432:5432 --name postgres \
  --restart=&quot;always&quot; \
  -v /pgdata:/var/lib/postgresql/data \
  -e POSTGRES&#95;USER=&quot;yetibot&quot; \
  -e POSTGRES&#95;PASSWORD=&quot;yetibot&quot; \
  -e POSTGRES&#95;DB=&quot;yetibot&quot; \
  postgres:latest

docker logs -f postgres

# to remove postgres docker container

docker rm -f postgres
</code></pre><p>Assuming you use a Docker link from another container to this container, the connection string is then:</p><pre><code class="bash">postgresql://yetibot:yetibot@postgres:5432/yetibot
</code></pre><p>As an example of Docker linking, you could use <code>psql</code> from another container like:</p><pre><code class="bash">docker run --rm -it --link postgres postgres bash
psql -h postgres -U yetibot
\l
\q
exit
</code></pre><h4 id="ubuntu&#95;vm">Ubuntu VM</h4><p>Much of this is borrowed from <a href='https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-16-04'>DigitalOcean's docs</a>:</p><pre><code class="bash">sudo apt-get update
sudo apt-get install -y postgresql postgresql-contrib
sudo -u postgres psql
createdb yetibot
</code></pre><h3 id="run&#95;it">Run it</h3><p>There are a few ways to quickly run a Yetibot:</p><ol><li>Docker - <a href='https://yetibot.com/ops-guide/#docker'>read the Yetibot on Docker docs</a></li><li>Grab an archive of the source from the <a href='https://github.com/yetibot/yetibot/releases'>Yetibot releases</a>, unzip, put the config in place and <code>lein run</code></li><li>Clone the source of this repo, put the config in place and <code>lein run</code></li></ol><p>As an example, here's how you could get the latest code from <code>master</code>, extract, put config in place, and run it (assumes you already have <a href='https://github.com/technomancy/leiningen'>Leiningen</a> installed):</p><pre><code class="bash">cd /tmp
curl https://codeload.github.com/yetibot/yetibot/tar.gz/master | tar xvz
cd yetibot-master
cat &lt;&lt; EOF &gt; config.edn
{:yetibot
 {:adapters
  {:freenode
   {:type &quot;irc&quot;
    :username &quot;my-yetibot&quot;
    :host &quot;chat.freenode.net&quot;
    :port &quot;7070&quot;
    :ssl &quot;true&quot;}}}}
EOF
YB&#95;LOG&#95;LEVEL=debug CONFIG&#95;PATH=config.edn lein run
</code></pre><p>Once it starts up you'll see a log like:</p><pre><code class="bash">17-05-28 23:27:56 deep.local INFO &#91;yetibot.core.loader:41&#93; - ‚òë Loaded 84 namespaces matching &#91;#&quot;&#94;yetibot\.&#40;core\.&#41;?commands.&#42;&quot; #&quot;&#94;.&#42;plugins\.commands.&#42;&quot;&#93;
</code></pre><p>At this point it should be connected to Freenode. Trying running a command against it:</p><pre><code class="bash">/msg my-yetibot !echo Hello, Yetibot!
</code></pre><p>And you should get a reply:</p><pre><code class="bash">my-yetibot: Hello, Yetibot!
</code></pre><h2 id="configuration">Configuration</h2><p>Yetibot can be fully configured via one or more mechanisms, in order of precedence with the first overriding the next:</p><ul><li>environment variables</li><li><code>leiningen</code> profiles EDN file</li><li>a config EDN file</li></ul><p>When multiple methods are specified the values are merged.</p><p>There are many configuration options in Yetibot. See sample configuration files annotated with inline documentation in all available formats:</p><ul><li><a href='https://github.com/yetibot/yetibot.core/blob/master/config/profiles.sample.clj'>profiles.sample.clj</a></li><li><a href='https://github.com/yetibot/yetibot.core/blob/master/config/config.sample.edn'>config.sample.edn</a></li><li><a href='https://github.com/yetibot/yetibot.core/blob/master/config/sample.env'>sample.env</a></li></ul><p>These are equivalent and both immutable (meaning they cannot change at runtime).</p><h3 id="rationale">Rationale</h3><p>Yetibot supports both immutable and mutable configuration, for configuring different parts of the system.</p><p>It's useful to change the configuration of a system at runtime in certain situations. It would be burdensome to have to login to a system where Yetibot runs, change config and restart Yetibot.</p><p>On the other hand, the benefits of immutability are well-known. Explicitly separating out the small amount of mutable config from the majority of immutable config lets us maximize immutability benefits and minimize negative affects of mutability in our system.</p><h3 id="modes">Modes</h3><h4 id="immutable">Immutable</h4><p><strong>Immutable config sources</strong> include both <code>profiles.clj</code> and environmental variables via <code>environ</code> and loading EDN from a file at <code>config/config.edn</code> (this can be overridden by specifying a <code>CONFIG&#95;PATH</code> env var).</p><p>Any config specified in an EDN file will be overridden by values provided by <code>environ</code>. Environment config can be explicitly ignored by setting an environment variable <code>YETIBOT&#95;ENV&#95;CONFIG&#95;DISABLED=true</code>.</p><p>Providing config via multiple methods makes it compatible with 12-factor configuration and simple usage in container environments while still retaining the ease of use of the EDN file option.</p><p>The majority of configurable sub-systems use immutable config as they do not need to change very often. Examples include:</p><ul><li>Chat adapters</li><li>Twitter credentials</li><li>Postgres connection string</li><li>etc.</li></ul><h4 id="mutable">Mutable</h4><p><strong>All mutable config is stored in the database</strong>.</p><p>A much smaller subset of commands need mutable config, e.g.:</p><ul><li>IRC channels</li><li>Channel settings</li></ul><h3 id="prefixes">Prefixes</h3><p>All immutable config, regardless of the source can be prefixed with either <code>yb</code> or <code>yetibot</code>. Examples:</p><h4 id="edn">edn</h4><pre><code class="clojure">{:yetibot {:log {:level &quot;debug&quot;}}}
</code></pre><pre><code class="clojure">{:yb {:url &quot;yetibot.com&quot;}}
</code></pre><h4 id="profile">Profile</h4><pre><code class="clojure">{:prod
 {:env
  {:yb-twitter-consumer-key &quot;foo&quot;}}}
</code></pre><h4 id="environment">Environment</h4><pre><code class="bash">YB&#95;GIPHY&#95;KEY=&quot;123&quot;
YETIBOT&#95;COMMAND&#95;PREFIX=&quot;,&quot;
</code></pre><h4 id="merged&#95;result">Merged result</h4><p>If you decided to configure Yetibot through all available means demonstrated above (not recommended but shown for purpose of illustration üòÖ), the merged config data structure would be:</p><pre><code class="clojure">{:log {:level &quot;debug&quot;}
 :command {:prefix &quot;,&quot;}
 :url &quot;yetibot.com&quot;
 :twitter {:consumer {:key &quot;foo&quot;}}
 :giphy {:key &quot;123&quot;}}
</code></pre><p>Note how environment variables are exploded into nested maps. This is powered by <a href='https://github.com/devth/dec'>dec</a> which you can read about in the blog post <a href='https://devth.com/2018/dec-deep-environmental-config'>dec: Deep Environmental Config</a>.</p><h2 id="poking&#95;the&#95;runtime">Poking the runtime</h2><p>Yetibot has a couple ways to poke around internal state at runtime. One is the typical-yet-amazing practice of exposing an nREPL. The other is its built in <code>eval</code> command. Let's take a look.</p><h3 id="nrepl">nREPL</h3><p>Yetibot exposes its <a href='https://nrepl.org/'>nREPL</a> on port <code>65432</code> by default. You can override this at config path: <code>:nrepl :port</code>.</p><p>This allows you to connect your local nREPL-based tools (e.g. vim-fireplace, CIDER, Cursive, or <a href='https://nrepl.org/nrepl/0.6.0/usage/clients.html'>many others</a>), load namespaces and evaluate expressions to read or mutate state making it the ultimate runtime debugging tool.</p><p>Some related resources:</p><ul><li><a href='https://devcenter.heroku.com/articles/debugging-clojure'>Live-Debugging Remote Clojure Apps with Drawbridge</a><ul><li>Yetibot doesn't expose the nREPL over HTTP (though we could, and perhaps is    not a bad idea!), but this post highlights the same idea and potential    workflow as socket-based connections.</li></ul></li></ul><p>In addition to connecting local tools, you can simply SSH to your server and connect to the REPL with <code>leiningen</code> like:</p><pre><code class="bash">ssh your-server
docker exec -it yetibot sh
lein repl :connect localhost:65432
</code></pre><h3 id="eval">Eval</h3><p>Yetibot ships with a command called <code>eval</code>:</p><pre><code>!help eval
</code></pre><p>Because it's so powerful it must be explicitly enabled per user in configuration. This is an admin-only feature, and maybe shouldn't be enabled at all for anyone.</p><p><article class="message is-warning"> <div class="message-header">   <p>‚ö†Ô∏è Warning ‚ö†Ô∏è</p> </div> <div class="message-body"> Be careful with <code>eval</code>! <strong>It has no limits.</strong> You can:</p><ul><li>mess up your Yetibot or bring it down</li><li>destroy stuff</li><li>expose your secrets to others in the channel</div></article></li></ul><p>Here are some examples at poking around with eval:</p><pre><code class="clojure">;; look at the state of the adapters
!eval &#40;map &#40;juxt yetibot.core.adapters.adapter/uuid yetibot.core.adapters.adapter/connected? yetibot.core.adapters.adapter/connection-latency&#41; &#40;yetibot.core.adapters.adapter/active-adapters&#41;&#41;
</code></pre><h2 id="dashboard">Dashboard</h2><p>Yetibot runs a web server that hosts a client-side web dashboard. The dashboard is powered by the <a href='https://github.com/yetibot/yetibot-dashboard'>yetibot-dashboard</a> NPM module, written in TypeScript. It compiles down to plain HTML, CSS and JavaScript, which Yetibot consumes and serves as static resources. The dashboard fetches all dynamic data from the local GraphQL API.</p><p>An example of the dashboard is hosted at <a href='https://public.yetibot.com'>public.yetibot.com</a>.</p><p>By default it runs on port <code>3003</code>, but you may override this by setting the <code>PORT</code> environment variable.</p><h2 id="health&#95;checks">Health checks</h2><p>Yetibot has a <code>/healthz</code> endpoint that should be use for heath checks. This endpoint checks the status of all configured adapters. If any adapter reports not being connected, <code>/healthz</code> responds <code>503 Service Unavailable</code>. Otherwise it responds <code>200 OK</code>.</p><p>See <a href='https://github.com/yetibot/yetibot.core/blob/master/src/yetibot/core/webapp/routes/healthz.clj'>healthz.clj</a> for the implementation.</p><h2 id="slack&#95;auto-reconnect">Slack auto-reconnect</h2><p>When a Slack connection is closed, we automatically try to reconnect with exponential back-off, up to 500 times. This usually works to restore the connection eventually unless there is a prolonged network outage and all 500 reconnect attempts are spent.</p><p>While a connection is open, we try to keep it open by sending <code>ping</code> event every 10 seconds, and expect a <code>pong</code> back within 5 seconds, as recommended in the <a href='https://api.slack.com/rtm'>Slack RTM docs</a>. If we fail to get a <code>pong</code> back within those 5 seconds, the connection is then marked in-active, causing the above <code>/healthz</code> endpoint to report <code>503</code>.</p><h2 id="ü§î">ü§î</h2><p><article class="message is-info"> <div class="message-header">   <p>Docs didn't answer your question?</p> </div> <div class="message-body">   Ask us in <a href='https://slack.yetibot.com'>Slack</a> or   <a href='https://github.com/yetibot/community/issues/new'>open a new issue</a>   on the <code>community</code> repo. </div> </article></p><p><span class="icon">   <i class="fab fa-github"></i> </span> <a href='https://github.com/yetibot/yetibot.github.io/blob/source/resources/templates/md/pages/ops-guide.md'>Edit this page</a></p>
        </div>

        <div class="column toc">
          <ol class="content"><li><a href="#up_and_running">Up and running</a></li><ol><li><a href="#docker_compose">Docker Compose</a></li><li><a href="#kubernetes_with_helm">Kubernetes with Helm</a></li><li><a href="#minimal_config">Minimal config</a></li><li><a href="#postgres">Postgres</a></li><ol><li><a href="#docker">Docker</a></li><li><a href="#ubuntu_vm">Ubuntu VM</a></li></ol><li><a href="#run_it">Run it</a></li></ol><li><a href="#configuration">Configuration</a></li><ol><li><a href="#rationale">Rationale</a></li><li><a href="#modes">Modes</a></li><ol><li><a href="#immutable">Immutable</a></li><li><a href="#mutable">Mutable</a></li></ol><li><a href="#prefixes">Prefixes</a></li><ol><li><a href="#edn">edn</a></li><li><a href="#profile">Profile</a></li><li><a href="#environment">Environment</a></li><li><a href="#merged_result">Merged result</a></li></ol></ol><li><a href="#poking_the_runtime">Poking the runtime</a></li><ol><li><a href="#nrepl">nREPL</a></li><li><a href="#eval">Eval</a></li></ol><li><a href="#dashboard">Dashboard</a></li><li><a href="#health_checks">Health checks</a></li><li><a href="#slack_auto-reconnect">Slack auto-reconnect</a></li><li><a href="#ü§î">ü§î</a></li></ol>
        </div>
      </div>

      <div id="prev-next">
        
        <a class="button is-warning" href="/dev-guide">&laquo; Dev Guide</a>
        
        

        
        
        <a class="button is-warning"
          href="/community">Community ‚Ü†</a>
        
      </div>
    </div>
  </div>

</section>



    </div>

    <footer class="footer">
      <div class="content has-text-centered">
        <p>
          <strong>Yetibot</strong> by <a href="https://devth.com">Trevor
            Hartman</a> & <a href="/community#core_team">contributors</a>.
          <br />
          Distributed under the
          <a href="https://opensource.org/licenses/eclipse-1.0.php">
            Eclipse Public License 1.0</a>.
          <br />
          Artwork by
          <a href="http://www.freeformdesign.co/">Freeform Design Co.</a>
          in <strong>Montana</strong>.
          <br />

          This site is continously delivered from
          <a href="https://github.com/yetibot/yetibot.github.io">
             source</a>.
        </p>
        <a onClick="window.scroll({top: 0, left: 0, behavior: 'smooth'});
          history.replaceState({}, '', window.location.pathname);">
          <img class="logo" src="/img/yetibot_logo.svg" />
        </a>
      </div>
    </footer>

    <script src="/js/dist.js?q=2210202012121" type="text/javascript" charset="utf-8"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <script src="/js/highlight.pack.js" type="text/javascript"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

